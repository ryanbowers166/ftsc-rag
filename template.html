<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTSC RAG Search Tool</title>
    <!-- Add markdown-it library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #374151; /* Dark gray background */
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #13AFFC; /* Blue header */
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 100px;
            width: auto;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .status-section {
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            display: none; /* Hidden from user */
        }

        .status-section h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status-healthy {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-loading {
            background: #fef3c7;
            color: #d97706;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .init-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .init-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .init-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .status-btn:hover {
            transform: translateY(-2px);
        }

        /* NEW: Refresh button for file cache */
        .refresh-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .refresh-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .query-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .query-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .query-input {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            width: 100%;
            max-width: 100%;
            transition: border-color 0.3s;
        }

        .query-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .submit-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            align-self: flex-start;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .example-queries {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #bae6fd;
        }

        .example-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 15px;
        }

        .example-item {
            background: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0f2fe;
            font-size: 14px;
        }

        .example-item:hover {
            background: #f0f9ff;
            transform: translateX(4px);
        }

        .response-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .response-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .response-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e293b;
        }

        .response-content {
            line-height: 1.6;
            color: #334155;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        /* NEW: Sources section styling */
        .sources-section {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #bae6fd;
        }

        .sources-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e0f2fe;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .source-item:hover {
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            transform: translateY(-1px);
        }

        .source-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .source-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .source-name {
            font-weight: 500;
            color: #1e293b;
            word-break: break-word;
            font-size: 14px;
        }

        .source-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .download-btn, .view-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .download-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #3730a3 0%, #6b21a8 100%);
            text-decoration: none;
            color: white;
            transform: translateY(-1px);
        }

        .view-btn {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .view-btn:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            text-decoration: none;
            color: white;
            transform: translateY(-1px);
        }

        .no-download {
            color: #6b7280;
            font-style: italic;
            font-size: 13px;
        }

        .sources-count {
            background: #4f46e5;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Markdown-specific styling */
        .response-content h1, .response-content h2, .response-content h3, .response-content h4, .response-content h5, .response-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #1e293b;
        }
        .response-content h1 {
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 8px;
            font-size: 1.8em;
        }
        .response-content h2 {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
            font-size: 1.4em;
        }
        .response-content h3 {
            font-size: 1.2em;
        }
        .response-content p {
            margin: 12px 0;
        }
        .response-content ul, .response-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        .response-content li {
            margin: 6px 0;
        }
        .response-content blockquote {
            margin: 16px 0;
            padding: 12px 16px;
            background: #f1f5f9;
            border-left: 4px solid #64748b;
            font-style: italic;
            border-radius: 4px;
        }
        .response-content code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        .response-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }
        .response-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        .response-content strong {
            font-weight: 600;
            color: #1e293b;
        }
        .response-content em {
            font-style: italic;
        }
        .response-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        .response-content th, .response-content td {
            border: 1px solid #e2e8f0;
            padding: 10px 14px;
            text-align: left;
        }
        .response-content th {
            background: #f8fafc;
            font-weight: 600;
        }
        .response-content a {
            color: #4f46e5;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .response-content a:hover {
            border-bottom-color: #4f46e5;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #fecaca;
            margin: 10px 0;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #bbf7d0;
            margin: 10px 0;
        }

        .info-block {
		background: #f1f5f9;
		border-top: 2px solid #e2e8f0;
		padding: 30px;
		text-align: left;
		font-size: 1em;
		color: #334155;
		max-width: 1200px;  /* match .container width */
		margin: 30px auto;  /* center and add spacing */
		border-radius: 20px; /* optional for consistency */
	}

	.info-block h2 {
		font-size: 1.5em;
		margin-bottom: 15px;
		color: #1e293b;
	}

	.info-block p {
		margin-bottom: 1em; /* spacing between paragraphs */
	}

	.info-block pre {
		background-color: #f4f4f4;
		padding: 12px;
		border-radius: 6px;
		overflow-x: auto;
		font-size: 0.9em;
		white-space: pre-wrap;   /* allow wrapping */
		word-wrap: break-word;   /* break long words */
	}

	.info-block .toggle-btn {
		display: inline-block;
		background: #3b82f6;
		color: white;
		padding: 6px 12px;
		margin-bottom: 10px;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.9em;
		border: none;
	}

	.info-block .toggle-btn:hover {
		background: #2563eb;
	}

		.instruction-block {
	    background: #f0f9ff;
	    border: 1px solid #bae6fd;
	    border-radius: 15px;
	    padding: 25px;
	    margin: 20px 30px;
	    color: #0c4a6e;
	    line-height: 1.6;
	}
	
	.instruction-block p {
	    margin-bottom: 12px;
	}
	
	.instruction-block ol {
	    margin: 12px 0;
	    padding-left: 24px;
	}
	
	.instruction-block li {
	    margin: 8px 0;
	}
	
	.instruction-block strong {
	    font-weight: 600;
	    color: #1e293b;
	}

        @media (max-width: 768px) {
            .query-form {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-logo {
                height: 50px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .submit-btn {
                align-self: stretch;
            }

            .source-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .source-actions {
                justify-content: center;
            }
            
            .download-btn, .view-btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/ftsc_logo.png" alt="FTSC Logo" class="header-logo">
            <div class="header-content">
                <h1>FTSC Paper Database Search Tool</h1>
                <p>Search the FTSC paper database using retrieval-augmented generation (RAG)</p>
            </div>
        </div>

		<div class="instruction-block">
		    <p><strong>Welcome to the Flight Test Safety Committee's paper database RAG search tool!</strong> This tool uses <strong>Retrieval Augmented Generation</strong>, a form of large language model automation.</p>
		    <p>You can use this tool to search the FTSC paper database for sources about a specific topic.</p>
		    <p><strong>Guidelines for using the tool:</strong></p>
		    <ol>
		        <li>You can ask in complete sentences ("What do I need to know about high-altitude flight test?") or short phrases ("high-altitude flight testing")</li>
		        <li>The LLM may create fake information ("hallucination"), or even make up entire sources. <strong>Carefully check all responses.</strong></li>
		        <li>If the model fails to find relevant sources ("No relevant information found in the available sources"), try submitting a slightly longer prompt.</li>
		    </ol>
		</div>

        <div class="main-content">
            <!-- System Status Section - Hidden from user but code preserved -->
            <div class="status-section">
                <h3>System Status</h3>
                <div id="statusDisplay" class="status-indicator status-loading">
                    <div class="loading-spinner"></div>
                    Checking system status...
                </div>
                <div class="button-group">
                    <button id="initButton" class="init-btn" onclick="initializeRAG()">Initialize RAG System</button>
                    <button onclick="checkStatus()" class="status-btn">Check Status</button>
                    <button id="refreshButton" class="refresh-btn" onclick="refreshFiles()">🔄 Refresh File Cache</button>
                </div>
            </div>

            <div class="query-section">
                <form id="queryForm">
                    <label for="query" class="query-label"> </label>
                    <textarea id="query" class="query-input" placeholder="Enter your query here..."></textarea>
                    <button type="submit" id="submitButton" class="submit-btn">Search</button>
                </form>

                <div id="results"></div>

                <div class="example-queries">
                    <div class="example-title">💡 Example Queries:</div>
                    <div class="example-item" onclick="setQuery('What do I need to know about high-altitude flight test?')">
                        What do I need to know about high-altitude flight test?
                    </div>
                    <div class="example-item" onclick="setQuery('What do I need to know about autonomous vehicle flight testing?')">
                        What do I need to know about autonomous vehicle flight testing?
                    </div>
                    <div class="example-item" onclick="setQuery('Are there lessons learned from flutter testing incidents?')">
                        Are there lessons learned from flutter testing incidents?
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="info-block" style="line-height: 1.6;">
    <h2>How does this tool work?</h2>
    
    <p>
        This tool uses a technique called <strong>Retrieval-Augmented Generation</strong>, 
        which uses a large language model (LLM) connected to a database of information (a "corpus").
    </p>
    
    <p>
        Retrieval-Augmented Generation (RAG) is a technique to fine-tune an LLM to a specific database or 
        use case without the need for retraining, which would be expensive and infeasible for small-scale use.
    </p>
    
    <p><strong>RAG does the following:</strong></p>
    
    <p>
        <strong>1. Corpus Creation:</strong> The files in the database ("corpus") are broken into 
        text "chunks" which are converted into numerical vectors ("embeddings") that encode their semantic meaning. 
        From this point on, the RAG tool only uses this vector database of chunk embeddings, and does not have access to the
        raw files (e.g. PDFs) in the original database.
    </p>
    
    <p>
        <strong>2. Document Retrieval:</strong> When you ask a query, it is converted into a numerical vector embedding 
        in the same way as the database files. The retrieval system then searches through the embeddings of all 
        corpus documents to find the document chunks that are most similar to the query (using vector euclidean distance or another metric). 
        These correspond to the most relevant documents.
    </p>
    
    <p>
        <strong>3. Context Assembly:</strong> The most relevant document chunks are retrieved and combined 
        with your original question to create a comprehensive context.
    </p>
    
    <p>
        <strong>4. Response Generation:</strong> A large language model (in our case, a lightweight variant 
        of Gemini) uses the combined context from step 3 to generate a response to your query.
    </p>
    
    <p>
        Because the context from step 3 only contains the most relevant content from the database, 
        the LLM's response is tailored to your query and is less likely to be distracted by irrelevant content.
    </p>
    
    <p>
        Like other LLM-based chat tools (e.g. ChatGPT, Claude, Gemini), this tool uses a system prompt 
        which your query is appended to. This prompt shapes the model's behavior, tone, and things it is 
        allowed and not allowed to say in response to your query. In our case, we use this system prompt:
    </p>
    
    <pre><code>
		You are a helpful chat agent helping a flight test professional analyze technical papers and documentation. You will help the user find relevant sources in the database about flight test techniques, procedures, considerations, and lessons learned.

        CRITICAL RULES:
        1. ONLY use information from the retrieved documents
        2. ALWAYS cite the exact source document name for every piece of information
        3. If no relevant information is found, say "No relevant information found in the available sources"
        4. Never create or invent source names - only use what's provided in the retrieval results
        5. Format sources as: "Source: [exact filename from retrieval]"
        6. For broad topics (e.g., "Autonomous vehicles"), provide a comprehensive overview covering multiple aspects
        7. For specific queries (e.g., "high altitude flight test sources"), focus on the specific topic requested
        
        Answer the user's question based solely on the retrieved information.
        
        User query: 
    </code></pre>
</div>

    <script>
        // Initialize markdown parser
        const md = window.markdownit({
            html: false,        // Disable HTML tags for security
            breaks: true,       // Convert '\n' to <br>
            linkify: true,      // Autoconvert URL-like text to links
            typographer: true   // Enable smart quotes and other typographic replacements
        });

        // Check status on page load
        window.onload = function() {
            checkStatus();
        };

        function checkStatus() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/status', true);

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        var statusDiv = document.getElementById('statusDisplay');
                        var initButton = document.getElementById('initButton');
                        var submitButton = document.getElementById('submitButton');

                        if (data.initialized) {
                            statusDiv.innerHTML = '✅ RAG system is initialized and ready!';
                            statusDiv.className = 'status-indicator status-healthy';
                            initButton.textContent = 'Re-initialize RAG System';
                            initButton.disabled = false;
                            submitButton.disabled = false;
                        } else {
                            statusDiv.innerHTML = '❌ RAG system is not initialized';
                            statusDiv.className = 'status-indicator status-error';
                            initButton.textContent = 'Initialize RAG System';
                            initButton.disabled = false;
                            submitButton.disabled = true;
                        }
                    } catch (e) {
                        document.getElementById('statusDisplay').innerHTML = '❌ Error checking status: ' + e.message;
                        document.getElementById('statusDisplay').className = 'status-indicator status-error';
                    }
                } else {
                    document.getElementById('statusDisplay').innerHTML = '❌ Error checking status: HTTP ' + xhr.status;
                    document.getElementById('statusDisplay').className = 'status-indicator status-error';
                }
            };

            xhr.onerror = function() {
                document.getElementById('statusDisplay').innerHTML = '❌ Network error while checking status';
                document.getElementById('statusDisplay').className = 'status-indicator status-error';
            };

            xhr.send();
        }

        function initializeRAG() {
            var initButton = document.getElementById('initButton');
            var statusDiv = document.getElementById('statusDisplay');

            initButton.disabled = true;
            initButton.innerHTML = '<div class="loading-spinner"></div>Initializing...';
            statusDiv.innerHTML = '<div class="loading-spinner"></div>Initializing RAG system, please wait...';
            statusDiv.className = 'status-indicator status-loading';

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/initialize', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            statusDiv.innerHTML = '✅ ' + data.message;
                            statusDiv.className = 'status-indicator status-healthy';
                            initButton.textContent = 'Re-initialize RAG System';
                            document.getElementById('submitButton').disabled = false;
                        } else {
                            statusDiv.innerHTML = '❌ Initialization failed: ' + (data.message || 'Unknown error');
                            statusDiv.className = 'status-indicator status-error';
                            initButton.textContent = 'Initialize RAG System';
                        }
                    } catch (e) {
                        statusDiv.innerHTML = '❌ Error parsing response: ' + e.message;
                        statusDiv.className = 'status-indicator status-error';
                        initButton.textContent = 'Initialize RAG System';
                    }
                } else {
                    statusDiv.innerHTML = '❌ HTTP Error: ' + xhr.status;
                    statusDiv.className = 'status-indicator status-error';
                    initButton.textContent = 'Initialize RAG System';
                }
                initButton.disabled = false;
            };

            xhr.onerror = function() {
                statusDiv.innerHTML = '❌ Network error during initialization';
                statusDiv.className = 'status-indicator status-error';
                initButton.textContent = 'Initialize RAG System';
                initButton.disabled = false;
            };

            xhr.send();
        }

        // NEW: Function to refresh Google Drive file cache
        function refreshFiles() {
            var refreshButton = document.getElementById('refreshButton');
            var originalText = refreshButton.textContent;
            
            refreshButton.textContent = '🔄 Refreshing...';
            refreshButton.disabled = true;
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/refresh-files', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            alert('✅ File cache refreshed! Found ' + data.file_count + ' files.');
                        } else {
                            alert('❌ Error refreshing files: ' + data.error);
                        }
                    } catch (e) {
                        alert('❌ Error parsing response: ' + e.message);
                    }
                } else {
                    alert('❌ HTTP Error: ' + xhr.status);
                }
                
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            };
            
            xhr.onerror = function() {
                alert('❌ Network error during file refresh');
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            };
            
            xhr.send();
        }

        // NEW: Function to display sources
        function displaySources(sources) {
            if (!sources || sources.length === 0) {
                return '';
            }
            
            var sourcesHtml = '<div class="sources-section">';
            sourcesHtml += '<div class="sources-title">📁 Sources <span class="sources-count">' + sources.length + '</span></div>';
            sourcesHtml += '<div class="sources-list">';
            
            sources.forEach(function(source) {
                var downloadLink = source.download_link || source.view_link;
                var fileName = source.name;
                
                sourcesHtml += '<div class="source-item">';
                sourcesHtml += '<div class="source-info">';
                sourcesHtml += '<span class="source-icon">📄</span>';
                sourcesHtml += '<span class="source-name">' + fileName + '</span>';
                sourcesHtml += '</div>';
                sourcesHtml += '<div class="source-actions">';
                
                if (downloadLink) {
                    sourcesHtml += '<a href="' + downloadLink + '" class="download-btn" title="Download ' + fileName + '" target="_blank" rel="noopener noreferrer">';
                    sourcesHtml += '<span>⬇️</span> Download</a>';
                } else {
                    sourcesHtml += '<span class="no-download">Download not available</span>';
                }
                
                if (source.view_link) {
                    sourcesHtml += '<a href="' + source.view_link + '" class="view-btn" title="View ' + fileName + '" target="_blank" rel="noopener noreferrer">';
                    sourcesHtml += '<span>👁️</span> View</a>';
                }
                
                sourcesHtml += '</div>';
                sourcesHtml += '</div>';
            });
            
            sourcesHtml += '</div></div>';
            return sourcesHtml;
        }

        function setQuery(query) {
            document.getElementById('query').value = query;
            document.getElementById('query').focus();
        }

        // UPDATED: Query form submission with sources support
        document.getElementById('queryForm').onsubmit = function(e) {
            e.preventDefault();

            var query = document.getElementById('query').value;
            if (!query.trim()) {
                document.getElementById('results').innerHTML = '<div class="error-message">Please enter a question</div>';
                return;
            }

            // Show loading state
            var submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner"></div>Processing...';

            // Create response section
            var responseSection = document.createElement('div');
            responseSection.className = 'response-section';
            responseSection.innerHTML = `
                <div class="response-header">
                    <div class="response-title">📄 Search Results</div>
                </div>
                <div class="response-content">
                    <div class="loading-spinner"></div> Processing your query...
                </div>
            `;

            document.getElementById('results').innerHTML = '';
            document.getElementById('results').appendChild(responseSection);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/query', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        var responseContent = responseSection.querySelector('.response-content');

                        if (data.error) {
                            responseContent.innerHTML = data.error;
                            responseContent.className = 'response-content error-message';
                        } else if (data.response) {
                            // Convert markdown to HTML
                            responseContent.innerHTML = md.render(data.response);
                            responseContent.className = 'response-content';
                            
                            // NEW: Display sources if available
                            if (data.sources && data.sources.length > 0) {
                                var sourcesHtml = displaySources(data.sources);
                                responseSection.insertAdjacentHTML('afterend', sourcesHtml);
                            }
                        }
                    } catch (parseError) {
                        var responseContent = responseSection.querySelector('.response-content');
                        responseContent.innerHTML = 'Parse error: ' + parseError.message;
                        responseContent.className = 'response-content error-message';
                    }
                } else {
                    var responseContent = responseSection.querySelector('.response-content');
                    responseContent.innerHTML = 'HTTP Error: ' + xhr.status;
                    responseContent.className = 'response-content error-message';
                }

                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Query';
            };

            xhr.onerror = function() {
                var responseContent = responseSection.querySelector('.response-content');
                responseContent.innerHTML = 'Network error occurred';
                responseContent.className = 'response-content error-message';

                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Query';
            };
            
            xhr.send(JSON.stringify({query: query}));
        };
		// Add this after the existing queryForm.onsubmit function
		document.getElementById('query').addEventListener('keydown', function(e) {
	    	if (e.key === 'Enter' && !e.shiftKey) {
	        	e.preventDefault();
	        	document.getElementById('queryForm').dispatchEvent(new Event('submit'));
	    		}
		});
    </script>
</body>
</html>










