<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTSC RAG Search Tool - TEST</title>
    <!-- Add markdown-it library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #374151; /* Dark gray background */
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #13AFFC; /* Blue header */
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 100px;
            width: auto;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .status-section {
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            display: none; /* Hidden from user */
        }

        .status-section h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status-healthy {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-loading {
            background: #fef3c7;
            color: #d97706;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .init-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .init-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .init-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .status-btn:hover {
            transform: translateY(-2px);
        }

        /* NEW: Refresh button for file cache */
        .refresh-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .refresh-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* NEW: Conversation history styles */
        .conversation-section {
            margin-bottom: 30px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            background: #f8fafc;
        }

        .conversation-header {
            background: #4f46e5;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .conversation-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .clear-chat-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .clear-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .conversation-messages {
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .user-avatar {
            background: #3b82f6;
        }

        .assistant-avatar {
            background: #10b981;
        }

        .message-content {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            border: 1px solid #e2e8f0;
            line-height: 1.6;
        }

        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: #1e293b;
        }
        .message-content h1 {
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 5px;
            font-size: 1.6em;
        }
        .message-content h2 {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 3px;
            font-size: 1.3em;
        }
        .message-content h3 {
            font-size: 1.1em;
        }
        .message-content p {
            margin: 10px 0;
        }
        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .message-content li {
            margin: 5px 0;
        }
        .message-content blockquote {
            margin: 12px 0;
            padding: 10px 12px;
            background: #f1f5f9;
            border-left: 3px solid #64748b;
            font-style: italic;
            border-radius: 3px;
        }
        .message-content code {
            background: #f1f5f9;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        .message-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
        }
        .message-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        .message-content strong {
            font-weight: 600;
            color: #1e293b;
        }
        .message-content em {
            font-style: italic;
        }
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }
        .message-content th, .message-content td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        .message-content th {
            background: #f8fafc;
            font-weight: 600;
        }
        .message-content a {
            color: #4f46e5;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .message-content a:hover {
            border-bottom-color: #4f46e5;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .query-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .query-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .query-input {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            width: 100%;
            max-width: 100%;
            transition: border-color 0.3s;
        }

        .query-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .submit-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            align-self: flex-start;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .example-queries {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #bae6fd;
        }

        .example-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 15px;
        }

        .example-item {
            background: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0f2fe;
            font-size: 14px;
        }

        .example-item:hover {
            background: #f0f9ff;
            transform: translateX(4px);
        }

        .response-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }

        .response-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .response-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e293b;
        }

        .response-content {
            line-height: 1.6;
            color: #334155;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        /* NEW: Sources section styling */
        .sources-section {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #bae6fd;
        }

        .sources-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e0f2fe;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .source-item:hover {
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            transform: translateY(-1px);
        }

        .source-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .source-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .source-name {
            font-weight: 500;
            color: #1e293b;
            word-break: break-word;
            font-size: 14px;
        }

        .source-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .download-btn, .view-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .download-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #3730a3 0%, #6b21a8 100%);
            text-decoration: none;
            color: white;
            transform: translateY(-1px);
        }

        .view-btn {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .view-btn:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            text-decoration: none;
            color: white;
            transform: translateY(-1px);
        }

        .no-download {
            color: #6b7280;
            font-style: italic;
            font-size: 13px;
        }

        .sources-count {
            background: #4f46e5;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #fecaca;
            margin: 10px 0;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #bbf7d0;
            margin: 10px 0;
        }

        .info-block {
		background: #f1f5f9;
		border-top: 2px solid #e2e8f0;
		padding: 30px;
		text-align: left;
		font-size: 1em;
		color: #334155;
		max-width: 1200px;  /* match .container width */
		margin: 30px auto;  /* center and add spacing */
		border-radius: 20px; /* optional for consistency */
	}

	.info-block h2 {
		font-size: 1.5em;
		margin-bottom: 15px;
		color: #1e293b;
	}

	.info-block p {
		margin-bottom: 1em; /* spacing between paragraphs */
	}

	.info-block pre {
		background-color: #f4f4f4;
		padding: 12px;
		border-radius: 6px;
		overflow-x: auto;
		font-size: 0.9em;
		white-space: pre-wrap;   /* allow wrapping */
		word-wrap: break-word;   /* break long words */
	}

	.info-block .toggle-btn {
		display: inline-block;
		background: #3b82f6;
		color: white;
		padding: 6px 12px;
		margin-bottom: 10px;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.9em;
		border: none;
	}

	.info-block .toggle-btn:hover {
		background: #2563eb;
	}

		.instruction-block {
	    background: #f0f9ff;
	    border: 1px solid #bae6fd;
	    border-radius: 15px;
	    padding: 25px;
	    margin: 20px 30px;
	    color: #0c4a6e;
	    line-height: 1.6;
	}
	
	.instruction-block p {
	    margin-bottom: 12px;
	}
	
	.instruction-block ol {
	    margin: 12px 0;
	    padding-left: 24px;
	}
	
	.instruction-block li {
	    margin: 8px 0;
	}
	
	.instruction-block strong {
	    font-weight: 600;
	    color: #1e293b;
	}

        @media (max-width: 768px) {
            .query-form {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-logo {
                height: 50px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .submit-btn {
                align-self: stretch;
            }

            .source-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .source-actions {
                justify-content: center;
            }
            
            .download-btn, .view-btn {
                flex: 1;
                justify-content: center;
            }

            .conversation-section {
                max-height: 400px;
            }

            .message {
                gap: 10px;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/ftsc_logo.png" alt="FTSC Logo" class="header-logo">
            <div class="header-content">
                <h1>FTSC Paper Database Search Tool - TEST</h1>
                <p>Search the FTSC paper database using retrieval-augmented generation (RAG)</p>
            </div>
        </div>

		<div class="instruction-block">
		    <p><strong>Welcome to the Flight Test Safety Committee's paper database RAG search tool!</strong> This tool uses <strong>Retrieval Augmented Generation</strong>, a form of large language model automation.</p>
		    <p>You can use this tool to search the FTSC paper database for sources about a specific topic and have multi-message conversations.</p>
		    <p><strong>Guidelines for using the tool:</strong></p>
		    <ol>
		        <li>You can ask in complete sentences ("What do I need to know about high-altitude flight test?") or short phrases ("high-altitude flight testing")</li>
		        <li>The LLM may create fake information (hallucinate), or even make up entire sources. <strong>Carefully check all responses.</strong></li>
		        <li>If the model fails to find relevant sources ("No relevant information found in the available sources"), try submitting a slightly longer prompt.</li>
		        <li><strong>NEW:</strong> You can now have multi-message conversations. Ask follow-up questions and the system will remember the conversation context.</li>
		    </ol>
		</div>

        <div class="main-content">
            <!-- System Status Section - Hidden from user but code preserved -->
            <div class="status-section">
                <h3>System Status</h3>
                <div id="statusDisplay" class="status-indicator status-loading">
                    <div class="loading-spinner"></div>
                    Checking system status...
                </div>
                <div class="button-group">
                    <button id="initButton" class="init-btn" onclick="initializeRAG()">Initialize RAG System</button>
                    <button onclick="checkStatus()" class="status-btn">Check Status</button>
                    <button id="refreshButton" class="refresh-btn" onclick="refreshFiles()">🔄 Refresh File Cache</button>
                </div>
            </div>

            <!-- NEW: Conversation History Section -->
            <div id="conversationSection" class="conversation-section" style="display: none;">
                <div class="conversation-header">
                    <div class="conversation-title">💬 Conversation History</div>
                    <button onclick="clearConversation()" class="clear-chat-btn">Clear Chat</button>
                </div>
                <div id="conversationMessages" class="conversation-messages">
                    <!-- Messages will be added here dynamically -->
                </div>
            </div>

            <div class="query-section">
                <form id="queryForm">
                    <label for="query" class="query-label">Ask a question or continue the conversation:</label>
                    <textarea id="query" class="query-input" placeholder="Enter your question here..."></textarea>
                    <button type="submit" id="submitButton" class="submit-btn">Send Message</button>
                </form>

                <div id="results"></div>

                <div class="example-queries">
                    <div class="example-title">💡 Example Queries:</div>
                    <div class="example-item" onclick="setQuery('What do I need to know about high-altitude flight test?')">
                        What do I need to know about high-altitude flight test?
                    </div>
                    <div class="example-item" onclick="setQuery('What does the database say about safety mishap accountability?')">
                        What does the database say about safety mishap accountability?
                    </div>
                    <div class="example-item" onclick="setQuery('Aircraft certification requirements')">
                        Aircraft certification requirements
                    </div>
                    <div class="example-item" onclick="setQuery('Can you tell me more about that?')">
                        Can you tell me more about that?
                    </div>
                    <div class="example-item" onclick="setQuery('What are the safety considerations for this?')">
                        What are the safety considerations for this?
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="info-block" style="line-height: 1.6;">
    <h2>How does this tool work?</h2>
    
    <p>
        This tool uses a technique called <strong>Retrieval-Augmented Generation</strong>, 
        which uses a large language model (LLM) connected to a database of information (a "corpus").
    </p>
    
    <p>
        Retrieval-Augmented Generation (RAG) is a technique to fine-tune an LLM to a specific database or 
        use case without the need for retraining, which would be expensive and infeasible for small-scale use.
    </p>
    
    <p><strong>RAG does the following:</strong></p>
    
    <p>
        <strong>1. Corpus Creation:</strong> The files in the database are broken into 
        text "chunks" which are converted into numerical vectors ("embeddings") that encode their semantic meaning. 
        From this point on, the RAG tool only uses this vector database of chunk embeddings, and does not have access to the
        raw files (e.g. PDFs) in the original database.
    </p>
    
    <p>
        <strong>2. Document Retrieval:</strong> When you ask a query, it is converted into a numerical vector embedding 
        in the same way as the database files. The retrieval system then searches through the embeddings of all 
        corpus documents to find the document chunks that are most similar to the query (using vector euclidean distance or another metric). 
        These correspond to the most relevant documents.
    </p>
    
    <p>
        <strong>3. Context Assembly:</strong> The most relevant document chunks are retrieved and combined 
        with your original question and conversation history to create a comprehensive context.
    </p>
    
    <p>
        <strong>4. Response Generation:</strong> A large language model (in our case, a lightweight variant 
        of Gemini) uses the combined context from step 3 to generate a response to your query.
    </p>
    
    <p>
        Because the context from step 3 only contains the most relevant content from the database, 
        the LLM's response is tailored to your query and is less likely to be distracted by irrelevant content.
    </p>
    
    <p>
        <strong>Multi-message conversations:</strong> This tool now maintains conversation history. Each new message 
        includes the previous conversation context, allowing for follow-up questions and coherent multi-turn discussions.
    </p>
    
    <p>
        Like other LLM-based chat tools (e.g. ChatGPT, Claude, Gemini), this tool uses a system prompt 
        which your query is appended to. This prompt shapes the model's behavior, tone, and things it is 
        allowed and not allowed to say in response to your query.
    </p>
</div>

    <script>
        // Initialize markdown parser
        const md = window.markdownit({
            html: false,        // Disable HTML tags for security
            breaks: true,       // Convert '\n' to <br>
            linkify: true,      // Autoconvert URL-like text to links
            typographer: true   // Enable smart quotes and other typographic replacements
        });

        // NEW: Conversation history storage
        let conversationHistory = [];

        // Check status on page load
        window.onload = function() {
            checkStatus();
            loadConversationHistory();
        };

        // NEW: Load conversation history from localStorage
        function loadConversationHistory() {
            try {
                const saved = localStorage.getItem('ftsc_conversation_history');
                if (saved) {
                    conversationHistory = JSON.parse(saved);
                    displayConversationHistory();
                }
            } catch (e) {
                console.log('No previous conversation history found');
                conversationHistory = [];
            }
        }

        // NEW: Save conversation history to localStorage
        function saveConversationHistory() {
            try {
                localStorage.setItem('ftsc_conversation_history', JSON.stringify(conversationHistory));
            } catch (e) {
                console.log('Could not save conversation history');
            }
        }

        // NEW: Display conversation history
        function displayConversationHistory() {
            const conversationSection = document.getElementById('conversationSection');
            const messagesContainer = document.getElementById('conversationMessages');
            
            if (conversationHistory.length === 0) {
                conversationSection.style.display = 'none';
                return;
            }
            
            conversationSection.style.display = 'block';
            messagesContainer.innerHTML = '';
            
            conversationHistory.forEach((item, index) => {
                // Add user message
                const userMessage = document.createElement('div');
                userMessage.className = 'message';
                userMessage.innerHTML = `
                    <div class="message-avatar user-avatar">U</div>
                    <div class="message-content">${escapeHtml(item.query)}</div>
                `;
                messagesContainer.appendChild(userMessage);
                
                // Add assistant message
                const assistantMessage = document.createElement('div');
                assistantMessage.className = 'message';
                assistantMessage.innerHTML = `
                    <div class="message-avatar assistant-avatar">A</div>
                    <div class="message-content">${md.render(item.response)}</div>
                `;
                messagesContainer.appendChild(assistantMessage);
                
                // Add sources if available
                if (item.sources && item.sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.innerHTML = displaySources(item.sources);
                    messagesContainer.appendChild(sourcesDiv);
                }
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // NEW: Clear conversation history
        function clearConversation() {
            if (confirm('Are you sure you want to clear the conversation history?')) {
                conversationHistory = [];
                saveConversationHistory();
                displayConversationHistory();
                document.getElementById('results').innerHTML = '';
            }
        }

        // NEW: Add message to conversation history
        function addToConversationHistory(query, response, sources = []) {
            conversationHistory.push({
                query: query,
                response: response,
                sources: sources,
                timestamp: new Date().toISOString()
            });
            saveConversationHistory();
            displayConversationHistory();
        }

        // NEW: Get conversation context for API
        function getConversationContext() {
            return conversationHistory.map(item => ({
                query: item.query,
                response: item.response
            }));
        }

        // NEW: Escape HTML for safety
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function checkStatus() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/status', true);

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        var statusDiv = document.getElementById('statusDisplay');
                        var initButton = document.getElementById('initButton');
                        var submitButton = document.getElementById('submitButton');

                        if (data.initialized) {
                            statusDiv.innerHTML = '✅ RAG system is initialized and ready!';
                            statusDiv.className = 'status-indicator status-healthy';
                            initButton.textContent = 'Re-initialize RAG System';
                            initButton.disabled = false;
                            submitButton.disabled = false;
                        } else {
                            statusDiv.innerHTML = '❌ RAG system is not initialized';
                            statusDiv.className = 'status-indicator status-error';
                            initButton.textContent = 'Initialize RAG System';
                            initButton.disabled = false;
                            submitButton.disabled = true;
                        }
                    } catch (e) {
                        document.getElementById('statusDisplay').innerHTML = '❌ Error checking status: ' + e.message;
                        document.getElementById('statusDisplay').className = 'status-indicator status-error';
                    }
                } else {
                    document.getElementById('statusDisplay').innerHTML = '❌ Error checking status: HTTP ' + xhr.status;
                    document.getElementById('statusDisplay').className = 'status-indicator status-error';
                }
            };

            xhr.onerror = function() {
                document.getElementById('statusDisplay').innerHTML = '❌ Network error while checking status';
                document.getElementById('statusDisplay').className = 'status-indicator status-error';
            };

            xhr.send();
        }

        function initializeRAG() {
            var initButton = document.getElementById('initButton');
            var statusDiv = document.getElementById('statusDisplay');

            initButton.disabled = true;
            initButton.innerHTML = '<div class="loading-spinner"></div>Initializing...';
            statusDiv.innerHTML = '<div class="loading-spinner"></div>Initializing RAG system, please wait...';
            statusDiv.className = 'status-indicator status-loading';

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/initialize', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            statusDiv.innerHTML = '✅ ' + data.message;
                            statusDiv.className = 'status-indicator status-healthy';
                            initButton.textContent = 'Re-initialize RAG System';
                            document.getElementById('submitButton').disabled = false;
                        } else {
                            statusDiv.innerHTML = '❌ Initialization failed: ' + (data.message || 'Unknown error');
                            statusDiv.className = 'status-indicator status-error';
                            initButton.textContent = 'Initialize RAG System';
                        }
                    } catch (e) {
                        statusDiv.innerHTML = '❌ Error parsing response: ' + e.message;
                        statusDiv.className = 'status-indicator status-error';
                        initButton.textContent = 'Initialize RAG System';
                    }
                } else {
                    statusDiv.innerHTML = '❌ HTTP Error: ' + xhr.status;
                    statusDiv.className = 'status-indicator status-error';
                    initButton.textContent = 'Initialize RAG System';
                }
                initButton.disabled = false;
            };

            xhr.onerror = function() {
                statusDiv.innerHTML = '❌ Network error during initialization';
                statusDiv.className = 'status-indicator status-error';
                initButton.textContent = 'Initialize RAG System';
                initButton.disabled = false;
            };

            xhr.send();
        }

        // NEW: Function to refresh Google Drive file cache
        function refreshFiles() {
            var refreshButton = document.getElementById('refreshButton');
            var originalText = refreshButton.textContent;
            
            refreshButton.textContent = '🔄 Refreshing...';
            refreshButton.disabled = true;
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/refresh-files', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            alert('✅ File cache refreshed! Found ' + data.file_count + ' files.');
                        } else {
                            alert('❌ Error refreshing files: ' + data.error);
                        }
                    } catch (e) {
                        alert('❌ Error parsing response: ' + e.message);
                    }
                } else {
                    alert('❌ HTTP Error: ' + xhr.status);
                }
                
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            };
            
            xhr.onerror = function() {
                alert('❌ Network error during file refresh');
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            };
            
            xhr.send();
        }

        // NEW: Function to display sources
        function displaySources(sources) {
            if (!sources || sources.length === 0) {
                return '';
            }
            
            var sourcesHtml = '<div class="sources-section">';
            sourcesHtml += '<div class="sources-title">📁 Sources <span class="sources-count">' + sources.length + '</span></div>';
            sourcesHtml += '<div class="sources-list">';
            
            sources.forEach(function(source) {
                var downloadLink = source.download_link || source.view_link;
                var fileName = source.name;
                
                sourcesHtml += '<div class="source-item">';
                sourcesHtml += '<div class="source-info">';
                sourcesHtml += '<span class="source-icon">📄</span>';
                sourcesHtml += '<span class="source-name">' + fileName + '</span>';
                sourcesHtml += '</div>';
                sourcesHtml += '<div class="source-actions">';
                
                if (downloadLink) {
                    sourcesHtml += '<a href="' + downloadLink + '" class="download-btn" title="Download ' + fileName + '" target="_blank" rel="noopener noreferrer">';
                    sourcesHtml += '<span>⬇️</span> Download</a>';
                } else {
                    sourcesHtml += '<span class="no-download">Download not available</span>';
                }
                
                if (source.view_link) {
                    sourcesHtml += '<a href="' + source.view_link + '" class="view-btn" title="View ' + fileName + '" target="_blank" rel="noopener noreferrer">';
                    sourcesHtml += '<span>👁️</span> View</a>';
                }
                
                sourcesHtml += '</div>';
                sourcesHtml += '</div>';
            });
            
            sourcesHtml += '</div></div>';
            return sourcesHtml;
        }

        function setQuery(query) {
            document.getElementById('query').value = query;
            document.getElementById('query').focus();
        }

        // UPDATED: Query form submission with conversation history support
        document.getElementById('queryForm').onsubmit = function(e) {
            e.preventDefault();

            var query = document.getElementById('query').value;
            if (!query.trim()) {
                document.getElementById('results').innerHTML = '<div class="error-message">Please enter a question</div>';
                return;
            }

            // Show loading state
            var submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="loading-spinner"></div>Processing...';

            // Create response section
            var responseSection = document.createElement('div');
            responseSection.className = 'response-section';
            responseSection.innerHTML = `
                <div class="response-header">
                    <div class="response-title">📄 Processing Your Message</div>
                </div>
                <div class="response-content">
                    <div class="loading-spinner"></div> Processing your query...
                </div>
            `;

            document.getElementById('results').innerHTML = '';
            document.getElementById('results').appendChild(responseSection);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/query', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        var responseContent = responseSection.querySelector('.response-content');

                        if (data.error) {
                            responseContent.innerHTML = data.error;
                            responseContent.className = 'response-content error-message';
                        } else if (data.response) {
                            // Convert markdown to HTML
                            responseContent.innerHTML = md.render(data.response);
                            responseContent.className = 'response-content';
                            
                            // Update response title
                            responseSection.querySelector('.response-title').textContent = '📄 Latest Response';
                            
                            // NEW: Add to conversation history
                            addToConversationHistory(query, data.response, data.sources || []);
                            
                            // NEW: Display sources if available
                            if (data.sources && data.sources.length > 0) {
                                var sourcesHtml = displaySources(data.sources);
                                responseSection.insertAdjacentHTML('afterend', sourcesHtml);
                            }
                            
                            // Clear the input
                            document.getElementById('query').value = '';
                        }
                    } catch (parseError) {
                        var responseContent = responseSection.querySelector('.response-content');
                        responseContent.innerHTML = 'Parse error: ' + parseError.message;
                        responseContent.className = 'response-content error-message';
                    }
                } else {
                    var responseContent = responseSection.querySelector('.response-content');
                    responseContent.innerHTML = 'HTTP Error: ' + xhr.status;
                    responseContent.className = 'response-content error-message';
                }

                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Send Message';
            };

            xhr.onerror = function() {
                var responseContent = responseSection.querySelector('.response-content');
                responseContent.innerHTML = 'Network error occurred';
                responseContent.className = 'response-content error-message';

                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Send Message';
            };
            
            // NEW: Include conversation history in the request
            xhr.send(JSON.stringify({
                query: query,
                conversation_history: getConversationContext()
            }));
        };

		// Add this after the existing queryForm.onsubmit function
		document.getElementById('query').addEventListener('keydown', function(e) {
	    	if (e.key === 'Enter' && !e.shiftKey) {
	        	e.preventDefault();
	        	document.getElementById('queryForm').dispatchEvent(new Event('submit'));
	    		}
		});
    </script>
</body>
</html>